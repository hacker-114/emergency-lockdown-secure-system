<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Google Sign-In Redirect</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    // Placeholder emails list → redirect mapping
    const specialEmails = {
      "teacher1@evergreenps.org": "https://67.com",
      "admin@evergreenps.org": "https://67.com",
      "example1@gmail.com": "https://67.com"
      // Add more as needed: "email":"redirect-link"
    };

    // Redirect links
    const redirectOnCancel = "https://hacker-114.github.io/please-sign-in/";
    const redirectEvergreenPS = "https://hacker-114.github.io/red-alert";
    // student.evergreenps.org → no redirect

    // Cookie helpers
    function setCookie(name, value, days) {
      const d = new Date();
      d.setTime(d.getTime() + (days*24*60*60*1000));
      const expires = "expires=" + d.toUTCString();
      document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
    }

    function getCookie(name) {
      const cname = name + "=";
      const decodedCookie = decodeURIComponent(document.cookie);
      const ca = decodedCookie.split(';');
      for(let i=0; i<ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(cname) === 0) {
          return c.substring(cname.length, c.length);
        }
      }
      return "";
    }

    function handleCredentialResponse(response) {
      const data = parseJwt(response.credential);
      const email = data.email;

      console.log("Signed in as:", email);

      // Save email in cookie for future visits
      setCookie("userEmail", email, 30);

      redirectBasedOnEmail(email);
    }

    function redirectBasedOnEmail(email) {
      // Check special emails first
      if (specialEmails[email]) {
        window.location.href = specialEmails[email];
        return;
      }

      // Check domain rules
      if (email.endsWith("@evergreenps.org")) {
        window.location.href = redirectEvergreenPS;
      } else if (email.endsWith("@student.evergreenps.org")) {
        // Student detected → show message
        console.log("You Have Been Detected as a Student");
        alert("You Have Been Detected as a Student");
      } else {
        console.log("No redirect rule matched.");
      }
    }

    // Helper: decode JWT
    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function handleCancel() {
      window.location.href = redirectOnCancel;
    }

    window.onload = function() {
      // Check cookie first
      const savedEmail = getCookie("userEmail");
      if (savedEmail) {
        console.log("Found saved email:", savedEmail);
        redirectBasedOnEmail(savedEmail);
        return; // Skip prompt if cookie exists
      }

      // Initialize Google Sign-In
      google.accounts.id.initialize({
        client_id: "679269140652-7d1pivqd4d269g1d0fmlivhqebnd2grt.apps.googleusercontent.com",
        callback: handleCredentialResponse,
        cancel_on_tap_outside: false
      });

      // Transparent prompt (no visible UI)
      google.accounts.id.prompt((notification) => {
        if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
          handleCancel();
        }
      });
    };
  </script>
  <style>
    /* Make everything invisible */
    body {
      background: transparent;
      color: transparent;
    }
    h1 {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Please Sign in for security measures</h1>
</body>
</html>
